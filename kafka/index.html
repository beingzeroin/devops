<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="niqdev">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Kafka - DevOps</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Kafka";
    var mkdocs_page_input_path = "kafka.md";
    var mkdocs_page_url = "/kafka/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-68888222-4', 'niqdev.github.io');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> DevOps</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../linux/">Linux</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../docker/">Docker</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../ansible/">Ansible</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cassandra/">Cassandra</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../zookeeper/">ZooKeeper</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Kafka</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#kafka">Kafka</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#architecture">Architecture</a></li>
        
            <li><a class="toctree-l3" href="#setup">Setup</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../hadoop/">Hadoop</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../kubernetes/">Kubernetes</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../readings/">Readings</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../other/">Other</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">DevOps</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Kafka</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/niqdev/devops/edit/master/docs/kafka.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="kafka">Kafka</h1>
<blockquote>
<p><strong>Kafka</strong> is a distributed streaming platform</p>
</blockquote>
<p>Documentation</p>
<ul>
<li>
<p><a href="https://kafka.apache.org">Kafka</a></p>
</li>
<li>
<p><a href="http://notes.stephenholiday.com/Kafka.pdf">Kafka: a Distributed Messaging System for Log Processing</a> (Paper)</p>
</li>
<li>
<p><a href="https://docs.confluent.io/current/schema-registry/docs/index.html">Schema Registry</a></p>
</li>
<li>
<p><a href="https://doc.akka.io/docs/akka-stream-kafka/current/home.html">Reactive Kafka</a></p>
</li>
</ul>
<h2 id="architecture">Architecture</h2>
<ul>
<li>
<p>Kafka is a publish/subscribe messaging system often described as a <em>distributed commit log</em> or <em>distributing streaming platform</em></p>
</li>
<li>
<p>The unit of data is called a <strong>message</strong>, which is simply an array of bytes and it can have a <strong>key</strong> used to assign partitions</p>
</li>
<li>
<p>A <strong>batch</strong> is a collection of messages, all of which are being produced to the same topic and partition</p>
</li>
<li>
<p>Messages are categorized into <strong>topics</strong> which are additionally broken down into a number of <strong>partitions</strong></p>
</li>
<li>
<p>Messages are written in an append-only fashion and are read in order from beginning to end. As a topic typically has multiple partitions, there is no guarantee of message time-ordering across the entire topic, just within a single partition</p>
</li>
<li>
<p>A <strong>stream</strong> is considered to be a single topic of data, regardless of the number of partitions</p>
</li>
<li>
<p><strong>Producers</strong>, publishers or writers, create new messages to a specific topic. By default, the producer does not care what partition a specific message is written to and will balance messages over all partitions of a topic evenly</p>
</li>
</ul>
<p><img alt="kafka-producer" src="../img/kafka-producer.png" /></p>
<ul>
<li><strong>Consumers</strong>, subscribers or readers, read messages. The consumer subscribes to one or more topics and reads the messages in the order in which they were produced. The consumer keeps track of which messages it has already consumed by keeping track of the <strong>offset</strong> of messages i.e. an integer value that continually
increases. Each message in a given partition has a unique offset stored either in Zookeeper or in Kafka itself</li>
</ul>
<p><img alt="kafka-consumer" src="../img/kafka-consumer.png" /></p>
<ul>
<li>
<p>Consumers work as part of a <strong>consumer group</strong>, which is one or more consumers that work together to consume a topic. The group assures that each partition is only consumed by one member. The mapping of a consumer to a partition is often called <strong>ownership</strong> of the partition by the consumer</p>
</li>
<li>
<p>When a new consumer is added to a group, or when a consumer shuts down or crashes leaving the group, it cause reassignment of partitions to other consumers. Moving partition ownership from one consumer to another is called a <strong>rebalance</strong> which provide high availability and scalability</p>
</li>
<li>
<p>Consumers maintain membership in a consumer group and ownership of the partitions assigned to them by sending <strong>heartbeats</strong> to a Kafka broker designated as the <strong>group coordinator</strong></p>
</li>
<li>
<p>You can't have multiple consumers that belong to the same group in one thread and you can't have multiple threads safely use the same consumer</p>
</li>
</ul>
<p><img alt="kafka-consumer-group" src="../img/kafka-consumer-group.png" /></p>
<ul>
<li>
<p>A single Kafka server is called a <strong>broker</strong>. The broker receives messages from producers, assigns offsets to them, and commits the messages to storage on disk. It also services consumers, responding to fetch requests for partitions and responding with the messages that have been committed to disk</p>
</li>
<li>
<p>Kafka brokers are designed to operate as part of a <strong>cluster</strong>. Within a cluster of brokers, one broker will also function as the cluster <strong>controller</strong>. The controller is responsible for administrative operations, including assigning partitions to brokers and monitoring for broker failures. A partition is owned by a single broker in the cluster, and that broker is called the <strong>leader</strong> of the partition. A partition may be assigned to multiple brokers, which will result in
the partition being replicated. All consumers and producers operating on that partition must connect to the leader</p>
</li>
</ul>
<p><img alt="kafka-cluster" src="../img/kafka-cluster.png" /></p>
<ul>
<li>
<p>A key feature is that of <strong>retention</strong>. Brokers are configured with a default retention setting for topics, either retaining messages for some period of time or until the topic reaches a certain size in bytes. Once these limits are
reached, messages are expired and deleted</p>
</li>
<li>
<p><strong>MirrorMaker</strong> is a tool to coordinates multiple clusters or datacenters and replicate data</p>
</li>
</ul>
<h2 id="setup">Setup</h2>
<p>Requirements</p>
<ul>
<li><a href="../docker/#base-image">Base</a> docker image </li>
<li><a href="../zookeeper">ZooKeeper</a> docker image</li>
</ul>
<p>Build <code>devops/kafka</code> image</p>
<pre><code class="bash"># change path
cd devops/kafka

# build image
docker build -t devops/kafka .

# create network
docker network create --driver bridge my_network
docker network ls
docker network inspect my_network

# start temporary zookeeper container [host:container]
docker run --rm \
  --name zookeeper \
  -p 12181:2181 \
  --network=my_network \
  devops/zookeeper
# access container
docker exec -it zookeeper bash

# start temporary kafka container [host:container]
docker run --rm \
  --name kafka \
  -p 19092:9092 \
  --network=my_network \
  -e ZOOKEEPER_HOSTS=&quot;zookeeper:2181&quot; \
  devops/kafka
# access container
docker exec -it kafka bash

# paths
/opt/kafka
/opt/kafka/logs
/var/log/kafka
/var/lib/kafka/data
</code></pre>

<p>Alternatively use <code>docker-compose</code></p>
<pre><code class="bash"># change path
cd devops/kafka

# build base image
docker build -t devops/base ../base
# build + start zookeeper and kafka
docker-compose up

# access container
docker exec -it devops-zookeeper bash
docker exec -it devops-kafka bash
</code></pre>

<p>Example</p>
<pre><code class="bash">docker exec -it kafka bash
cd /opt/kafka/bin

# create topic
./kafka-topics.sh --create --zookeeper zookeeper:2181 --replication-factor 1 --partitions 1 --topic test

# view topic
./kafka-topics.sh --list --zookeeper zookeeper:2181
./kafka-topics.sh --zookeeper zookeeper:2181 --describe --topic test

# produce
./kafka-console-producer.sh --broker-list kafka:9092 --topic test

# consume
./kafka-console-consumer.sh --bootstrap-server kafka:9092 --topic test --from-beginning
</code></pre>

<p><br></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../hadoop/" class="btn btn-neutral float-right" title="Hadoop">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../zookeeper/" class="btn btn-neutral" title="ZooKeeper"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/niqdev/devops/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../zookeeper/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../hadoop/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
